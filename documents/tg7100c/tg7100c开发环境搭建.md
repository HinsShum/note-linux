# TG7100C开发环境搭建

**宿主机：**`Linux moorgen-Vostro-3681 5.19.0-32-generic #33~22.04.1-Ubuntu SMP PREEMPT_DYNAMIC Mon Jan 30 17:03:34 UTC 2 x86_64 x86_64 x86_64 GNU/Linux`

**注意：**本文档讲述的是如何在ubuntu22.04（包括wsl2）中通过docker搭建tg7100c开发环境（如果不希望通过docker搭建，建议使用Ubuntu16.04）

## 1. 准备工作

### 1.1 安装Docker

```bash
sudo apt update
# 安装docker依赖
sudo apt install -y ca-certificates curl gnupg lsb-release
# 启用docker官方存储库
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg
echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
# 安装docker
sudo apt update
sudo apt install -y docker-ce docker-ce-cli containerd.io
# 查看安装结果
docker version
# 如果docker服务未启动的话可以运行以下命令
sudo service docker start
```

### 1.2 创建容器

```bash
# 创建64位ubuntu16.04的容器并进入容器, 容器命名为tg7100c(名字可随意更改)
sudo docker run -it --name tg7100c ubuntu:16.04 bash
```

## 2. 安装环境

### 2.1 安装依赖

```bash
# 安装32位运行时环境
dpkg --add-architecture i386
apt update
apt install -y libssl-dev:i386 libncurses-dev:i386 libreadline-dev:i386
# 安装依赖
apt install -y git wget make flex bison gperf unzip gcc-multilib libssl-dev libncurses-dev libreadline-dev
```

## 2.2 安装python3

注意：使用`apt install python3`进行安装的python3版本为3.5，此版本无法进行后续操作，无法使用，这里使用的是python3.9.9（其他版本未进行过验证）

```bash
# 安装依赖
apt-get install -y zlib1g-dev libbz2-dev libssl-dev libncurses5-dev libsqlite3-dev libffi-dev
# 下载源码至'/usr/local/src'
wget https://www.python.org/ftp/python/3.9.9/Python-3.9.9.tgz
mv Python-3.9.9.tgz /usr/local/src
# 进入/usr/local/src目录并解压
cd /usr/local/src
tar xvf Python-3.9.9.tgz
# 编译并安装
cd Python-3.9.9
./configure prefix=/usr/local/python3.9.9
make && make install
# 设置软链接
ln -s /usr/local/python3.9.9/bin/python3 /usr/bin/python
ln -s /usr/local/python3.9.9/bin/pip /usr/bin/pip
```

## 2.3 安装python依赖

```bash
# 创建工作目录
mkdir /home/tg7100c
cd /home/tg7100c
# 创建python虚拟环境(如果想要全局安装则可以跳过虚拟环境的搭建直接安装依赖)
python -m venv ./.venv
# 进入虚拟环境
source .venv/bin/activate
# 安装依赖，以下步骤必须按照顺序执行，否则会安装失败
pip install --upgrade pip
pip install --upgrade setuptools
pip install wheel
pip install pyserial
pip install scons
pip install cryptography --only-binary=:all:
pip install esptool
pip install aos-cube
# 查看aos-cube安装结果，如打印0.5.11则安装成功
aos-cube --version
```

备注：

* pip: 23.0.1
* setuptools: 67.6.1
* wheel: 0.40.0
* pyserial: 3.5
* scons: 4.5.2
* cryptography: 40.0.1
* esptool: 4.5.1
* aos-cube: 0.5.11

## 3. SDK

```bash
# 下载sdk
git clone https://code.aliyun.com/living_platform/ali-smartliving-device-alios-things.git -b rel_1.6.6
# 安装依赖（此处是为了解决编译时丢失en_US.UTF-8的警告）
apt install -y locales
# 安装en_US.UTF-8
locale-gen en_US.UTF-8
# 编译sdk
cd ali-smartliving-device-alios-things
./build.sh example smart_outlet tg7100cevb MAINLAND ONLINE 1
```

## 4. 基于docker镜像创建容器

跳过步骤2和步骤3，快速搭建tg7100c开发环境

已知镜像压缩包为**ubuntu-tg7100c.tar.gz**

```bash
# 解压镜像压缩包得到镜像tar包: ubuntu-tg7100c.tar
tar -zxvf ubuntu-tg7100c.tar.gz
# 将tar包导入为docker镜像
sudo docker load < ubuntu-tg7100c.tar
# 使用导入的镜像创建容器（该容器内已搭建好tg7100c的开发环境, 可直接使用）
sudo docker run -it --name tg7100c ubuntu:tg7100c bash
```

## 5.其他

```bash
# 退出python虚拟环境
deactivate
# 退出docker(也可直接按ctrl+D)
exit
# 进入容器
sudo docker exec -it [name] bash
# 查看所有容器
sudo docker ps -a
# 查看所有docker镜像
sudo docker images
```

